---
title: '[Firestore]transactionã§æ‚²è¦³ãƒ­ãƒƒã‚¯ã§ããªã„'
tags:
  - Firebase
  - Transaction
  - Firestore
private: false
updated_at: '2022-06-25T17:35:15+09:00'
id: 82179b6f8287cb9fa66c
organization_url_name: null
slide: false
ignorePublish: false
---
è¤‡æ•°ã®å‡¦ç†ãŒé€£ç¶šã—ã¦è¡Œã‚ã‚Œã‚‹å ´åˆã«transactionã®æ’ä»–åˆ¶å¾¡ã‚’ç”¨ã„ã‚‹ã“ã¨ã¯å¤šãã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ä»Šå›firestoreã®transactionä¸­ã§æ‚²è¦³ãƒ­ãƒƒã‚¯ã‚’ç”¨ã„ãŸã®ã§ã™ãŒãªãœã‹ã†ã¾ãã„ã‹ãªã„äº‹è±¡(åˆ†é›¢ãƒ¬ãƒ™ãƒ«å‹˜é•ã„ã—ã¦ã„ãŸã ã‘)ãŒèµ·ããŸã®ã§è§£æ±ºæ³•ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

[firebaseã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ä½¿ã„æ–¹](https://zenn.dev/yucatio/articles/7c4ba0d0138ca9)

# å•é¡Œ
ç°¡æ½”ã«è¨€ã†ã¨æ¬¡ã®å‡¦ç†ã‚’ã—ã¦ã„ãŸã€‚
1. tokenã‚’å–å¾—
1. apiã‚’å©ã(token)
1. tokenãŒæ›´æ–°ã•ã‚Œã‚‹ã®ã§ä¿å­˜
```js
admin.firestore().runTransaction(async (transaction) => {
  const token = await transaction.get(...)
  const res = await postApi(token)
  transaction.set(res.token)
})
```

ã“ã“ã§transaction A,BãŒé€£ç¶šã—ã¦å®Ÿè¡Œã•ã‚ŒãŸæ™‚ã€transaction.getã®æ™‚ç‚¹ã§ãƒ­ãƒƒã‚¯ã•ã‚Œã€transactionã®çµ‚äº†ã¾ã§å¾…æ©Ÿã™ã‚‹æƒ³å®šã§ã‚ã£ãŸã€‚
```
1. [A] é–‹å§‹
1. [B] é–‹å§‹
1. [A] get
1. [B] getã‚’å¾…æ©Ÿ
1. [A] postApi
1. [A] çµ‚äº†
1. [B] getå®Œäº†
1. [B] postApi
1. [B] çµ‚äº†
```
å®Ÿéš›ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šãƒ­ãƒƒã‚¯ã§ãã¦ã„ãªã‹ã£ãŸï¼Ÿ
```
1. [A] é–‹å§‹
1. [B] é–‹å§‹
1. [A] get
1. [B] get
1. [A] postApi
1. [B] postApi
1. [B] ã‚¨ãƒ©ãƒ¼
1. [A] çµ‚äº†
```

# è§£æ±ºæ³•
æ™®é€šã«transactionè‡ªä½“ã¯æ­£ã—ãå‹•ã„ã¦ã„ãŸã®ã§ä»»æ„ã®å›æ•°retryã•ã›ãŸã€‚
```js
admin.firestore().runTransaction(async (transaction) => {
  const token = await transaction.get(...)
  const res = (await postApi(token)).catch((e) => å†åº¦å®Ÿè¡Œ)
  transaction.set(res.token)
})
```

åŸå› ã¨ã—ã¦ã¯åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã®ç†è§£ãŒç”˜ã‹ã£ãŸã€‚
firestoreã®åˆ†é›¢ãƒ¬ãƒ™ãƒ«ãŒ"READ COMMITTED"ã§ã‚ã‚Šã€æ›´æ–°ã‚’æ¤œçŸ¥ã—ãŸæ™‚ã«å†åº¦getã™ã‚‹ã¿ãŸã„ã€‚
ğŸ”½è©³ç´°

https://qiita.com/1amageek/items/2eff436fb69bea5875ea
